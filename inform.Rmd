---
title: "Studying HIV indicators from the last 20 years"
author: "Violeta Roizman @L2S-CentraleSup√©lec and @IC-FCEN-UBA"
date: "Febrary 2019"
output:
  html_document:
    df_print: paged
subtitle: UseR!2019 Datathon submission
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse) # data science workflow
library(here) # relative paths
library(colorspace) # palette
library(scales) # number format
library(feather) # fast read and write

# maps
library(maps)
library(rmapshaper)
library(geojsonio)
library(leaflet)

# missing data
library(naniar)
library(missMDA)

# embedding
library(umap)

library(dbscan)

# palette
my_palette <- rainbow_hcl(8)
```

Here I present my analysis of the "Health, Nutrition and Population Statistics" dataset hosted by the World Bank Group. It was compiled from an RMarkdown file `datathon2019.Rmd`. A Shiny App showing the discussed topic and other visualizations can be accessed here. All the code that I used to build both documents is available in my github @violetr. 

Here I analyzed the evolution regarding HIV, paying special attention to risk areas. I analyze the related indicators like knowledge about the virus and spread of safe practices.  

## Importing and tidying the data

First of all I had to import the data, I did this with the `readr` package. I chose to use the `tidyverse` environment instead of the `data.table` package because the computational needs were not too high and code is more readable with `dplyr`.

```{r, eval=FALSE, echo=FALSE, warning=FALSE, include = FALSE, message= FALSE}
countries_hnp <- read_csv(here::here("data", "HNP_StatsCountry.csv"))

dataset_hnp <- read_csv(here::here("data", "HNP_StatsData.csv")) %>%
  select(-X63)

indicators_hnp <- read_csv(here::here("data", "HNP_StatsSeries.csv"))
```

I tidied the data with `dplyr`, `stringr` and `tidyr` from the `tidyverse` and I selected the columns of interest for the analysis. 

```{r, eval=FALSE, echo=FALSE, warning=FALSE, include=FALSE, message= FALSE}
# select relevant variables and rename variables

# INDICATORS
indicators_hnp_keep <- indicators_hnp %>%
  select(`Series Code`, `Topic`, `Indicator Name`, `Long definition`)

# I change the names because I like it better without spaces
colnames(indicators_hnp_keep) <- colnames(indicators_hnp_keep) %>%
  str_to_lower() %>%
  str_replace(" ", "_")

# extract first part of the topic to have more general clasification
split_topic <- str_split(indicators_hnp_keep$topic, pattern = ":")

indicators_hnp_keep <- indicators_hnp_keep %>%
  mutate(gen_topic = map_chr(split_topic, 
                             ~.x[1]), # general topic
         part_topic = map_chr(split_topic, 
                             ~.x[2])) # particular topic

# COUNTRIES
countries_hnp_keep <- countries_hnp %>%
  select(`Country Code`, `Short Name`, `Table Name`, `Long Name`, `2-alpha code`, `Currency Unit`, Region, `Income Group`, `Lending category`, `Government Accounting concept`)

colnames(countries_hnp_keep) <- colnames(countries_hnp_keep) %>%
  str_to_lower() %>%
  str_replace(" ", "_")

# DATASET
colnames(dataset_hnp)[1:4] <- colnames(dataset_hnp)[1:4] %>%
  str_to_lower() %>%
  str_replace(" ", "_")

# CHECKING
# subset by general topic
count_indicator_by_topic <- dataset_hnp %>% 
  left_join(indicators_hnp_keep, by= c("indicator_code"="series_code")) %>%
  select(-topic, -indicator_name.x, -indicator_name.y, -long_definition) %>%
  filter(country_name=="Arab World") %>% # keep a random "country" to avoid repetition
  count(gen_topic, sort = TRUE)
# HEALTH and EDUCATION most common

# checking names
countries <- dataset_hnp %>%
  select(country_name) %>%
  unique() 
  
# in dataset we have grouped countries
# by region, by income, etc
# also in countries dataset

# I filter countries with no currency unit: aggregations
not_countries <- countries_hnp_keep %>% 
  filter(is.na(currency_unit)) %>%
  pull(table_name)
#length(not_countries) # 41

real_countries <- countries_hnp_keep %>% 
  filter(!is.na(currency_unit)) %>%
  pull(table_name)

#########################

# I reshape with gather and spread
# because it is handful to have indicators as features
# I also split into 3 different datasets: health, education or others indicators
dataset_hnp_education = dataset_hnp %>% 
  left_join(indicators_hnp_keep, by= c("indicator_code"="series_code")) %>%
  select(-topic, -indicator_name.x, -indicator_name.y, -long_definition, -part_topic) %>%
  filter(gen_topic=="Education") %>%
  filter(country_name %in% real_countries) %>%
  gather(key = year, value = indicator_value, `1960`:`2017`) %>% 
  spread(key = indicator_code, value = indicator_value) %>%
  left_join(countries_hnp_keep, by = c("country_code"= "country_code")) %>%
  mutate(year = as.integer(year))
############################
# test to check the reshape: 
#
# dataset_hnp %>%
#   filter(country_name=="Afghanistan", indicator_code=="SE.ADT.LITR.FE.ZS") %>%
#   select(`1984`)
# 
# dataset_hnp_education %>%
#   filter(country_name=="Afghanistan", year=="1984") %>%
#   select(SE.ADT.LITR.FE.ZS)
############################


dataset_hnp_others = dataset_hnp %>% 
  left_join(indicators_hnp_keep, by= c("indicator_code"="series_code")) %>%
  select(-topic, -indicator_name.x, -indicator_name.y, -long_definition, -part_topic) %>%
  filter(gen_topic!="Education", gen_topic!="Health") %>%
  filter(country_name %in% real_countries) %>%
  select(-gen_topic) %>%
  gather(key = year, value = indicator_value, `1960`:`2017`) %>%
  spread(key = indicator_code, value = indicator_value) %>%
  left_join(countries_hnp_keep, by = c("country_code"= "country_code")) %>%
  mutate(year = as.integer(year))

dataset_hnp_health = dataset_hnp %>% 
  left_join(indicators_hnp_keep, by = c("indicator_code"="series_code")) %>%
  select(-topic, -indicator_name.x, -indicator_name.y, -long_definition, -part_topic) %>%
  filter(gen_topic=="Health") %>% 
  filter(country_name %in% real_countries) %>%
  gather(key = year, value = indicator_value, `1960`:`2017`) %>%
  spread(key = indicator_code, value = indicator_value) %>%
  left_join(countries_hnp_keep, by = c("country_code"= "country_code")) %>%
  mutate(year = as.integer(year))

# Save the tidy datasets
write_feather(dataset_hnp, 
          here::here("data", "dataset_hnp_exp"))
write_feather(dataset_hnp_health, 
          here::here("data", "dataset_hnp_health_exp"))
write_feather(dataset_hnp_education, 
          here::here("data", "dataset_hnp_education_exp"))
write_feather(indicators_hnp_keep,
          here::here("data", "indicators_hnp_exp"))
write_feather(countries_hnp_keep,
          here::here("data", "countries_hnp_exp"))
write_feather(dataset_hnp_others,
          here::here("data", "dataset_hnp_others_exp"))
```

For some analyses I used the `naniar` package to visualize the presence of missing data because of the big amount of missing data for some indicators, countries and periods of time. I also used `missMDA` to impute missing values with PCA method in the last part.

```{r, include=FALSE, message=FALSE}
# load the tidy data once it has been created
# to be faster

dataset_hnp <- read_feather(here::here("data", "dataset_hnp_exp"))

dataset_hnp_health <- read_feather(here::here("data", "dataset_hnp_health_exp"))
  
dataset_hnp_education <- read_feather(here::here("data", "dataset_hnp_education_exp"))

dataset_hnp_others <- read_feather(here::here("data", "dataset_hnp_others_exp"))

indicators_hnp_keep <- read_feather(here::here("data", "indicators_hnp_exp"))

countries_hnp_keep <- read_feather(here::here("data", "countries_hnp_exp"))

real_countries <- countries_hnp_keep %>% # real countries are not aggregations
  filter(!is.na(currency_unit)) %>%      # I identify them because they don't  
  pull(table_name)                       # have currency unit 
```

This is a table including all the available indicators that directly related with the virus and the syndrome:

```{r, results="asis", echo=FALSE}
indicators_hnp_keep %>%
  filter(str_detect(indicator_name, "AIDS") | str_detect(indicator_name, "HIV") |
           str_detect(indicator_name, "Condom")) %>%
  select(indicator_name, series_code) 
```

There are also other related indicators like education and access to the health system.

```{r, results="asis", echo=FALSE, eval=FALSE}
indicators_hnp_keep %>% # get particular topics
  pull(part_topic) %>%
  unique()

indicators_hnp_keep %>% 
  filter(part_topic == " Disease prevention") %>%
  select(indicator_name, series_code) 
```

## Affected population and progression

### How many people are living with HIV? How has this number evolved in the last 20 years?

The following plot can be really alarming:

```{r, echo=FALSE}
# decimal format: (not scientific)
point <- format_format(big.mark = "", decimal.mark = ",", scientific = FALSE)

dataset_hnp_health %>% 
  select(country_name, year, SH.HIV.TOTL) %>%
  filter(year >= 1997) %>%
  group_by(year) %>%
  summarize(aids=sum(SH.HIV.TOTL, na.rm=TRUE)) %>% # sum from all countries
  ungroup() %>%
  ggplot(aes(year, aids, group=1)) +
  geom_line(size=0.8) + 
  xlab("Year") +
  ylab("# of people") +
  ggtitle("Number of people in the world infected with HIV") +
  scale_x_continuous(breaks = c(1997, 2002, 2007, 2012, 2017)) +
  scale_y_continuous(name="# of people", labels = point)
```

Infected population has been growing in the last 20 years. But this one looks much better:

```{r, echo=FALSE}
dataset_hnp_health %>% 
  select(country_name, year, SH.HIV.INCD, SH.DYN.AIDS.DH) %>%
  filter(year >= 1997) %>%
  group_by(year) %>%
  summarize(aids.new=sum(SH.HIV.INCD, na.rm=TRUE), # new infections
            aids.deaths = sum(SH.DYN.AIDS.DH, na.rm = TRUE)) %>% # number of deaths
  ungroup() %>%
  select(year, aids.new, aids.deaths) %>%
  gather(aids.new, aids.deaths, key = "indicator", value = "value") %>%
  ggplot() +
  geom_line(aes(year, value, color = indicator), size=0.8) +
  ggtitle("Number of new HIV infections and deaths related with AIDS") +
  xlab("Year") +
  ylab("# of people") +
  scale_x_continuous(breaks = c(1997, 2002, 2007, 2012, 2017)) +
  scale_color_discrete(labels = c("AIDS-related deaths", "New infected"))
```

The number of new infections is decreasing and the number of deaths related with AIDS is also decreasing since 2005. In a sense the first graph shows good news, because  infected population is living more years. Let's analyze by countries.

### Which countries are the most affected?

Let's look at the percent of population living with HIV in 2017

```{r, echo=FALSE}
dataset_hnp_health %>% 
  select(country_name, year, SH.HIV.TOTL, SP.POP.TOTL) %>%
  filter(year == 2017) %>% # currently
  mutate(aids.prop = SH.HIV.TOTL/SP.POP.TOTL*100) %>% # percent
  filter(!is.na(aids.prop)) %>%
  select(country_name, aids.prop) %>%
  arrange(desc(aids.prop)) %>%
  head(10)

by_risk <- dataset_hnp_health %>% 
  select(country_name, year, SH.HIV.TOTL, SP.POP.TOTL) %>%
  filter(year == 2017) %>%
  mutate(aids.prop = SH.HIV.TOTL/SP.POP.TOTL*100) %>%
  filter(!is.na(aids.prop)) %>%
  select(country_name, aids.prop) %>%
  arrange(desc(aids.prop)) %>%
  pull(country_name) 

high_risk = by_risk[1:20] # high risk countries

```

Africa has been the most afected continent. It's even clearer when we look the following choropleth:

```{r, echo = FALSE, warning=FALSE, message=FALSE}
aids_countries <- dataset_hnp_health %>% 
  select(country_code, year, SH.HIV.TOTL, SP.POP.TOTL) %>% 
  filter(year == 2017) %>%
  mutate(proportion_aids = SH.HIV.TOTL / SP.POP.TOTL * 100) %>%
  filter(!is.na(proportion_aids)) %>%
  select(-year)

# load world map
#countries_geo <- geojsonio::geojson_read(here::here("app_hnp","www", "countries.geojson"), what = "sp")

# simplify it because too heavy to shiny
#countries_simple <- rmapshaper::ms_simplify(countries_geo, keep = 0.05, keep_shapes = TRUE)

#saveRDS(countries_simple, file = "app_hnp/data/countries_simple.rds")
# I load the simplified version to be faster
countries_geo <- readRDS(here::here("app_hnp", "data", "countries_simple.rds"))

# join with aids
countries_geo@data <- countries_geo@data %>%
  left_join(aids_countries, by= c("ISO_A3"="country_code")) %>%
  select(ADMIN, ISO_A3, proportion_aids)

# palette
binpal <- colorBin("Reds", countries_geo$proportion_aids, 9, pretty = FALSE)

# interactive labels 
labels_geo_year <-
  paste0(
    "<strong>", countries_geo$ADMIN, "</strong>",
    ifelse(is.na(countries_geo$proportion_aids),
      "",
      paste0(
        "<br/>",
        round(countries_geo$proportion_aids, 4),
        "%"
      )
    )
  ) %>%
  lapply(htmltools::HTML) # because of html syntax

# plot interactive map
leaflet(data = countries_geo) %>%
  setView(35, 37.8, 1.4) %>%
  addProviderTiles("MapBox", options = providerTileOptions(
    id = "mapbox.light",
    accessToken = Sys.getenv("MAPBOX_ACCESS_TOKEN")
  )) %>%
  addPolygons(
    fillColor = ~ binpal(proportion_aids),
    weight = 2,
    opacity = 1,
    color = "white",
    dashArray = "2",
    fillOpacity = 0.7,
    highlight = highlightOptions(
      weight = 2,
      color = "#999",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE
    ),
    label = labels_geo_year,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto"
    )
  ) %>%
  addLegend(
    pal = binpal,
    values = ~ (countries_geo$proportion_aids),
    opacity = 0.7,
    title = "% living with HIV",
    position = "bottomright",
    na.label = "No data"
  )
```

In particular the afected area is the South of Africa, with countries from the North of Africa with one of the lowest HIV-infection shares. 

## Treatment, education and self practices

Some information about Antiretroviral treatment (ART) from avert.org:

> ART works by keeping the level of HIV in your body low (your viral load). This lets your immune system recover and stay strong. Keeping your viral load low also helps to prevent HIV being passed on.

This means that the treatment possitively affects non-only the number of AIDS-related deaths, but it also decreases the new infections.

```{r, message=FALSE, warning=FALSE, echo=FALSE}
dataset_hnp_health %>% 
  select(country_name, year, SH.HIV.ARTC.ZS, region) %>%
  filter(year >= 1997, str_detect(region, "Africa")) %>%
  group_by(year) %>%
  summarize(aids=mean(SH.HIV.ARTC.ZS, na.rm=TRUE)) %>%
  ungroup() %>%
  ggplot(aes(year, aids, group=1)) +
  geom_line(size=0.8) + 
  xlab("Year") +
  ylab("Percent of HIV infected people") +
  ggtitle("Percent of African population infected with HIV that is treated with ART") +
  scale_x_continuous(breaks = c(1997, 2002, 2007, 2012, 2017))
```

> PMTCT programmes provide a range of services to women and infants. These include preventing HIV infections among women of reproductive age (15‚Äì49 years), preventing unwanted pregnancies among women living with HIV, and providing women living with HIV with lifelong ART to maintain their health and prevent transmission during pregnancy, labour and breastfeeding.
PMTCT programmes also support safe childbirth practices and appropriate infant feeding, as well as providing infants exposed to HIV with virological testing after birth and during the breastfeeding period, ART for prevention and effective treatment.
Without treatment, if a pregnant woman is living with HIV the likelihood of the virus passing from mother-to-child is 15% to 45%. However, antiretroviral treatment (ART) and other interventions can reduce this risk to below 5%.


```{r, message=FALSE, warning=FALSE, echo=FALSE}
dataset_hnp_health %>% 
  select(country_name, year, SH.HIV.PMTC.ZS, region) %>%
  filter(year >= 1997, str_detect(region, "Africa")) %>%
  group_by(year) %>%
  summarize(aids=mean(SH.HIV.PMTC.ZS, na.rm=TRUE)) %>%
  ungroup() %>%
  ggplot(aes(year, aids, group=1)) +
  geom_line(size=0.8) + 
  xlab("Year") +
  ylab("Percent of HIV infected people") +
  ggtitle("Percent of the people infected with HIV that is treated with ARV") +
  scale_x_continuous(breaks = c(2007, 2012, 2017), limits = c(2007,2017))
```


Of course the education, and in particular HIV knowledge is highly related with the spread of the virus.

```{r, message=FALSE, warning=FALSE, echo=FALSE}
dataset_hnp_health %>% 
  select(country_name, year, SH.HIV.KNOW.FE.ZS, region) %>%
  filter(year >= 1997, str_detect(region, "Africa")) %>%
  vis_miss() # a lot of missing data

# countries that have biggest number measures in the period
more_info = dataset_hnp_health %>% 
  select(country_name, year, SH.HIV.KNOW.FE.ZS, region) %>%
  filter(year>=1997, 
         str_detect(region, "Africa"),
         !is.na(SH.HIV.KNOW.FE.ZS)) %>%
  group_by(country_name) %>%
  summarise(count=dplyr::n()) %>%
  arrange(desc(count)) %>%
  pull(country_name) 

dataset_hnp_health %>% 
  select(country_name, year, SH.HIV.KNOW.FE.ZS, region) %>%
  filter(year>=1997, 
         str_detect(region, "Africa"),
         !is.na(SH.HIV.KNOW.FE.ZS),
         country_name %in% more_info[1:8],
         country_name %in% high_risk) %>%
  ggplot(aes(year, SH.HIV.KNOW.FE.ZS, color= country_name, group = country_name)) +
  geom_line(size=0.8) +
  xlab("Year") +
  ylab("Percent of females") +
  ggtitle("Number of people in the world infected with HIV") +
  scale_x_continuous(breaks = c(1997, 2002, 2007, 2013, 2017), limits = c(1997,2017))
```

```{r, message=FALSE, warning=FALSE, echo=FALSE}
dataset_hnp_health %>% 
  select(country_name, year, SH.HIV.KNOW.MA.ZS, region) %>%
  filter(year >= 1997, str_detect(region, "Africa")) %>%
  group_by(year) %>%
  summarize(aids=mean(SH.HIV.KNOW.MA.ZS, na.rm=TRUE)) %>%
  ungroup() %>%
  ggplot(aes(year, aids, group=1)) +
  geom_line(size=0.8) + 
  xlab("Year") +
  ylab("# of people") +
  ggtitle("Number of people in the world infected with HIV") +
  scale_x_continuous(breaks = c(1998, 2003, 2007, 2012, 2016), limits = c(1997,2017))
```


```{r, message=FALSE, warning=FALSE, echo=FALSE}
more_info = dataset_hnp_health %>% 
  select(country_name, year, SH.CON.AIDS.FE.ZS, SH.CON.1524.FE.ZS, SH.CON.1524.FE.ZS, region) %>%
  filter(year>=1997, 
         str_detect(region, "Africa"),
         !is.na(SH.CON.AIDS.FE.ZS)) %>%
  group_by(country_name) %>%
  summarise(count=dplyr::n()) %>%
  arrange(desc(count)) %>%
  pull(country_name) 

dataset_hnp_health %>% 
  select(country_name, year, SH.CON.AIDS.FE.ZS, SH.CON.1524.FE.ZS, SH.CON.1524.FE.ZS, region) %>%
  filter(year>=1997, 
         str_detect(region, "Africa"),
         !is.na(SH.CON.AIDS.FE.ZS),
         country_name %in% more_info[1:8],
         country_name %in% high_risk) %>%
  ggplot(aes(year, SH.CON.AIDS.FE.ZS, color= country_name, group = country_name)) +
  geom_line(size=0.8) +
  xlab("Year") +
  ylab("Percent of females") +
  ggtitle("Number of people in the world infected with HIV") +
  scale_x_continuous(breaks = c(1998, 2003, 2007, 2012, 2016), limits = c(1997,2017))
```

## Studing country clustering depending different aspects

Let's see how countries are grouped dedending on different groups of features

# Country embeddings

UMAP is a new (2018) embedding algorithm that has a similar scheme to t-SNE, the well-known state of the art non-linear embedding algorithm. Their objective is to visualize high-dimensional datasets in 2D or 3D preserving neighborhoods in terms of distances.  

I embedded the dataset to 2D  having into account different subsets of features. I based my feature subsets in health and nutritional, educational, economical and gender aspects. Like that I could visualize how countries group with regard to the different aspect and check if the resulting clusterings change and how they are related to the geographical location.

### HIV aspect

```{r, echo=FALSE, message=FALSE, warning=FALSE}
custom.config = umap.defaults
custom.config$random_state = 44
custom.config$min_dist = 0.1

# UMAP embedding for a year, health

an_year <- 2015

#indicators_hnp_keep %>%
#  filter(gen_topic == "Health") %>%
#  pull(part_topic) %>%
#  unique()

# I keep comparable indicators (%)
comparable_health_indicators <- indicators_hnp_keep %>%
  filter((str_detect(indicator_name, "%") | str_detect(indicator_name, "rate")) & (str_detect(indicator_name, "AIDS") | str_detect(indicator_name, "HIV") |
           str_detect(indicator_name, "Condom")) ,
         gen_topic == "Health",
         ! part_topic %in% " Population") %>%
  pull(series_code)

dataset_comparable_health <- dataset_hnp_health %>%
  filter(year == an_year) %>%
  select(country_name, country_code, region, one_of(comparable_health_indicators))  %>%
  select_if(function(x) (sum(is.na(x)) <= (0.4 * length(x))) || is.character(x))


res.comp <- imputePCA(as.data.frame(dataset_comparable_health[, 4:ncol(dataset_comparable_health)]))
dataset_comparable_health_com <-  res.comp$comp
  
data_to_umap <- as.matrix(dataset_comparable_health_com)
data_health_umap <- umap(data_to_umap, config = custom.config)

data_umap_health <- tibble(x = data_health_umap$layout[, 1],
                           y = data_health_umap$layout[, 2],
                           country = dataset_comparable_health$country_code,
                           region = dataset_comparable_health$region)

#pdf(here::here("figures/umap_1995.pdf"), height = 8, width = 18)
data_umap_health %>% 
  ggplot(aes(x, y, color= region, label = country)) +
  geom_point() +
  geom_text(aes(label=country),hjust=0, vjust=0,show.legend = FALSE) +
  theme_void()
#dev.off()

hiv_cl <- hdbscan(data_umap_health[, c(1, 2)], minPts = 6)$cluster

clt_to_map <- data_umap_health %>%
  select(country) %>%
  mutate(cstr = hiv_cl)

paleta = rainbow_hcl(8, c = 35, l = 85)

factpal <- colorFactor(paleta, clt_to_map$cstr )

countries_geo <- readRDS(here::here("app_hnp", "data", "countries_simple.rds"))

countries_geo@data <- countries_geo@data %>%
  left_join(clt_to_map, by= c("ISO_A3"="country")) %>%
  select(ADMIN, ISO_A3, cstr)

leaflet(data = countries_geo) %>%
  setView(0, 37.8, 1.3) %>%
  addProviderTiles("MapBox", options = providerTileOptions(
    id = "mapbox.light",
    accessToken = Sys.getenv('MAPBOX_ACCESS_TOKEN'))) %>%
  addPolygons(fillColor = ~factpal(cstr),
  weight = 2,
  opacity = 1,
  color = "white",
  dashArray = "2",
  fillOpacity = 0.7,
  highlight = highlightOptions(
    weight = 2,
    color = "#999",
    dashArray = "",
    fillOpacity = 0.7,
    bringToFront = TRUE),
  label = countries_geo$ADMIN,
  labelOptions = labelOptions(
    style = list("font-weight" = "normal", padding = "3px 8px"),
    textsize = "15px",
    direction = "auto"))

```

