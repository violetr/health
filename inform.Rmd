---
title: "Health Nutrition and Population Statistics report"
author: "Violeta Roizman"
date: "23 de diciembre de 2018"
output: pdf_document
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# data science workflow
library(tidyverse)
library(ggthemes) # ggplot2
library(here)

# maps
library(ggmap)
library(maps)
library(plotly)
library(rmapshaper)
library(geojsonio)
library(leaflet)

# embedding
library(umap)
```

This is the result of an analysis of the "Health, Nutrition and Population Statistics" dataset hosted by the World Bank Group. A Shiny App showing all the interesting visualizations can be accessed here. 

I focused the analysis on the male/female.

## Importing and tidying the data

Of course first of all we import the data, we do this with the `readr` package.

```{r, echo=FALSE, warning=FALSE}
countries_hnp <- read_csv(here::here("data", "HNP_StatsCountry.csv"))

dataset_hnp <- read_csv(here::here("data", "HNP_StatsData.csv")) %>%
  select(-X63)

indicators_hnp <- read_csv(here::here("data", "HNP_StatsSeries.csv"))
```


We tidy the data with `dplyr`, `stringr` and `tidyr` from the `tidyverse`. We select the columns we care about.

```{r, echo=FALSE, warning=FALSE}
# select relevant variables and rename variables

# INDICATORS
indicators_hnp_keep <- indicators_hnp %>%
  select(`Series Code`, `Topic`, `Indicator Name`, `Long definition`)

# I change the names because I like it better without spaces
colnames(indicators_hnp_keep) <- colnames(indicators_hnp_keep) %>%
  str_to_lower() %>%
  str_replace(" ", "_")

# extract to have more general clasification
split_topic <- str_split(indicators_hnp_keep$topic, pattern = ":")

indicators_hnp_keep <- indicators_hnp_keep %>%
  mutate(gen_topic = map_chr(split_topic, 
                             ~.x[1]),
         part_topic = map_chr(split_topic, 
                             ~.x[2]))

# COUNTRIES
countries_hnp_keep <- countries_hnp %>%
  select(`Country Code`, `Short Name`, `Table Name`, `Long Name`, `2-alpha code`, `Currency Unit`, Region, `Income Group`, `Lending category`, `Government Accounting concept`)

colnames(countries_hnp_keep) <- colnames(countries_hnp_keep) %>%
  str_to_lower() %>%
  str_replace(" ", "_")

# DATASET
colnames(dataset_hnp)[1:4] <- colnames(dataset_hnp)[1:4] %>%
  str_to_lower() %>%
  str_replace(" ", "_")

# CHECKING
# subset by general topic
count_indicator_by_topic <- dataset_hnp %>% 
  left_join(indicators_hnp_keep, by= c("indicator_code"="series_code")) %>%
  select(-topic, -indicator_name.x, -indicator_name.y, -long_definition) %>%
  filter(country_name=="Arab World") %>%
  count(gen_topic, sort = TRUE)
# HEALTH and EDUCATION most common

# checking names
countries <- dataset_hnp %>%
  select(country_name) %>%
  unique() 
  
#View(countries) # in dataset we have grouped countries
                # by region, by income, etc

# also in countries dataset
# I filter countries with no currency unit: aggregations
not_countries <- countries_hnp_keep %>% 
  filter(is.na(currency_unit)) %>%
  pull(table_name)

#length(not_countries) # 41

real_countries <- countries_hnp_keep %>% 
  filter(!is.na(currency_unit)) %>%
  pull(table_name)

#########################

# I reshape with gather and spread
# because it is handful to have indicators as features
dataset_hnp_education = dataset_hnp %>% 
  left_join(indicators_hnp_keep, by= c("indicator_code"="series_code")) %>%
  select(-topic, -indicator_name.x, -indicator_name.y, -long_definition, -part_topic) %>%
  filter(gen_topic=="Education") %>%
  filter(country_name %in% real_countries) %>%
  gather(key = year, value = indicator_value, `1960`:`2017`) %>%
  spread(key = indicator_code, value = indicator_value)

############################
# test to check the reshape: 

dataset_hnp %>%
  filter(country_name=="Afghanistan", indicator_code=="SE.ADT.LITR.FE.ZS") %>%
  select(`1984`)

dataset_hnp_education %>%
  filter(country_name=="Afghanistan", year=="1984") %>%
  select(SE.ADT.LITR.FE.ZS)
############################

dataset_hnp_health = dataset_hnp %>% 
  left_join(indicators_hnp_keep, by= c("indicator_code"="series_code")) %>%
  select(-topic, -indicator_name.x, -indicator_name.y, -long_definition, -part_topic) %>%
  filter(gen_topic=="Health") %>% 
  filter(country_name %in% real_countries) %>%
  gather(key = year, value = indicator_value, `1960`:`2017`) %>%
  spread(key = indicator_code, value = indicator_value)

# Save the tidy datasets
write_csv(dataset_hnp_health, 
          here::here("data", "dataset_hnp_health_exp.csv"))
write_csv(dataset_hnp_education, 
          here::here("data", "dataset_hnp_education_exp.csv"))
write_csv(indicators_hnp_keep,
          here::here("data", "indicators_hnp_exp.csv"))
```

```{r}
dataseth_hnp_health <- read_csv(here::here("data", "dataset_hnp_health_exp.csv"))
  
indicators_hnp_keep <- read_csv(here::here("data", "indicators_hnp_exp.csv"))
```

## Example HIV
```{r, echo=FALSE}
indicators_hnp_keep %>%
  filter(series_code=="SH.DYN.AIDS") %>%
  pull(long_definition)
# Adults living with HIV refers to the number of people ages 15-49 
# who are infected with HIV.

dataset_hnp_health %>% 
  select(country_name, year, SH.DYN.AIDS) %>%
  group_by(country_name) %>%
  summarize(aids=mean(SH.DYN.AIDS, na.rm=TRUE)) %>%
  filter(!is.na(aids)) %>%
  arrange(desc(aids))

dataset_hnp_health %>%
  filter(country_name=="Nigeria") %>%
  select(country_name, year, SH.DYN.AIDS) %>%
  filter(!is.na(SH.DYN.AIDS)) %>%
  mutate(year = as.integer(year)) %>%
  ggplot(aes(x=year, y=SH.DYN.AIDS)) +
  geom_line() +
  ylab("Number of people") +
  ggtitle("Evolution of the number of people infected with HIV in Nigeria")


     
aids_countries <- dataset_hnp_health %>% 
  select(country_code, year, SH.DYN.AIDS, SP.POP.TOTL) %>% 
  filter(year == 2000) %>%
  mutate(proportion_aids = SH.DYN.AIDS / SP.POP.TOTL) %>%
  filter(!is.na(proportion_aids)) %>%
  select(-year)

map_world <- map_data("world") %>%
  filter(region!="Antarctica", 
         region!="French Southern and Antarctic Lands") 

mapis = maps::map("world", fill=TRUE, plot=FALSE)

# pdf(here::here("figures/mapa11.pdf"), height = 8, width = 18)
cloro <- aids_countries %>%
  inner_join(maps::iso3166, by = c("country_code" = "a3")) %>%
  right_join(world, by = c(mapname = "region")) %>%
  ggplot(aes(long, lat, group=group, fill= proportion_aids, text=paste0(mapname))) +
  scale_fill_gradient2(low="blue", high="red", 
                      midpoint = 0.1, , limits=c(0, 0.18),
                      labels= scales::percent_format()) +
  geom_polygon() +
  theme_map() +
  coord_cartesian(ylim = c(-50, 90)) 

cloro %>%
  ggplotly(tooltip = "text") %>%
  style(hoverlabel = list(bgcolor = "white"), hoveron = "fill")
# dev.off()

mapa_leafe <- aids_countries %>%
  inner_join(maps::iso3166, by = c("country_code" = "a3")) %>%
  right_join(world, by = c(mapname = "region"))

verdes <- colorNumeric("Reds", domain = c(0,18), na.color = "#808080", alpha = FALSE,
  reverse = FALSE)

binpal <- colorBin("Reds", countries_geo$proportion_aids, 9, pretty = FALSE)

class(mapis)

countries_geo <- geojsonio::geojson_read(here::here("app_hnp","www", "countries.geojson"), what = "sp")

countries_simple <- rmapshaper::ms_simplify(countries_geo, keep = 0.05, keep_shapes = TRUE)
saveRDS(countries_simple, file = "app_hnp/data/countries_simple.rds")

countries_geo@data <- countries_geo@data %>%
  left_join(aids_countries, by= c("ISO_A3"="country_code")) %>%
  select(ADMIN, ISO_A3, proportion_aids)

leaflet(data = countries_geo) %>%
  setView(0, 37.8, 1.3) %>%
  addProviderTiles("MapBox", options = providerTileOptions(
    id = "mapbox.light",
    accessToken = Sys.getenv('MAPBOX_ACCESS_TOKEN'))) %>%
  addPolygons(fillColor = ~binpal(proportion_aids),
  weight = 2,
  opacity = 1,
  color = "white",
  dashArray = "2",
  fillOpacity = 0.7,
  highlight = highlightOptions(
    weight = 2,
    color = "#999",
    dashArray = "",
    fillOpacity = 0.7,
    bringToFront = TRUE),
  label = countries_geo$ADMIN,
  labelOptions = labelOptions(
    style = list("font-weight" = "normal", padding = "3px 8px"),
    textsize = "15px",
    direction = "auto"))


```

```{r, echo=FALSE, eval=FALSE}
indicators = indicators_hnp_keep %>%
  select(indicator_name)

#View(indicators)

dataset_hnp %>% 
  filter(country_name=="Arab World") %>%
  left_join(indicators_hnp_keep, 
            by = c("indicator_code"="series_code")) %>%
  select(-topic, -indicator_name.y, -long_definition) %>%
  filter(gen_topic!="Education", gen_topic!="Health") %>%
  pull(indicator_name.x)

# HEALTH:

# knowledge HIV, female/male
# ado fertility rate
# % people HIV, nuevos infectados , adults, adults nuevos infectados
# children HIV, children new infected, huerfanos por hiv 
# age first marriage
# population age i , for all 0<=i<=25
# % pregnagnt women with HIV treated
# edad dependency ratio?, old, young
# AIDS deaths
# ARI treatment (% of children under 5 taken to a health provider)
# birth rate
# Births attended by skilled health staff 
# Capital health expenditure
# cause of death communicable, mother or injury or 
# Current health expenditure
# diarrea
# People with basic handwashing facilities
# drinking water, sanitation facilities
# "Community health workers (per 1,000 people)"
#Exclusive breastfeeding
# # hospital beds
# inmunization
# life expectancy
# risk of maternal death
# low weight babies
# malaria
# mortality rate water
# Number of people who are undernourished
# # nurses
# People practicing open defecation
# # physicians
# suicides
# alcohol
# tuberculosis


# FEMALE/MALE:
# knowledge hiv
# hiv
# Comprehensive correct knowledge of HIV/AIDS youngs
# Condom use with non regular partner
# age first marriage
# population age i , for all 0<=i<=25
# % pregnagnt women with HIV treated
# birth rate
# Births attended by skilled health staff 
# Completeness of birth registration (%)
# Contraceptive prevalence, any methods
# Contraceptive prevalence, modern methods
# female polulation ranges
# fertility rates
# malnutrition
# maternal leave benefits
# maternal mortality
# Mortality rate attributed to unintentional poisoning
# Pregnant women receiving prenatal care (%
# anemia
# overweight 
# smoking
# teenage mother
# married before 18

# EDUCATION:
# male/fem:
# literacy rate
# Primary completion rate
# School enrollment, primary, secondary, tertiary
# 
# public spending

# OTHERS:
# GNI
# HCI
# labor force
# unemployment
```


# UMAP embedding

With the `umap` package we embed the dataset with health features to 2D to visualize the neighborhoods.

```{r, echo=FALSE}
# UMAP embedding for a year, health

an_year <- 1995

#indicators_hnp_keep %>%
#  filter(gen_topic == "Health") %>%
#  pull(part_topic) %>%
#  unique()

# I keep comparable indicators (%)
comparable_health_indicators <- indicators_hnp_keep %>%
  filter(str_detect(indicator_name, "%"),
         gen_topic == "Health",
         ! part_topic %in% " Population") %>%
  pull(series_code)

dataset_comparable_health <- dataset_hnp_health %>%
  filter(year == an_year) %>%
  select(country_name, country_code, one_of(comparable_health_indicators))  %>%
  select_if(function(x) (sum(is.na(x)) <= (0.2 * length(x))) || is.character(x)) %>%
  drop_na()
  
data_to_umap <- as.matrix(dataset_comparable_health[, 3:ncol(dataset_comparable_health)])
data_health_umap <- umap(data_to_umap)

data_umap_health <- tibble(x = data_health_umap$layout[, 1], 
                           y = data_health_umap$layout[, 2],
                           country = dataset_comparable_health$country_code)

# esto se puede optimizar poniendolo desde el principio en dataset
data_umap_health <- data_umap_health %>%
  left_join(countries_hnp_keep, by = c("country"= "country_code")) %>%
  select(x, y, country, region)

#pdf(here::here("figures/umap_1995.pdf"), height = 8, width = 18)
data_umap_health %>% 
  ggplot(aes(x, y, color= region, label = country)) +
  geom_point() +
  geom_text(aes(label=country),hjust=0, vjust=0) +
  theme_void()
#dev.off()
```


